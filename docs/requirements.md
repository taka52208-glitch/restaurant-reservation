# 飲食店予約サイト - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
飲食店の席予約プラットフォーム。顧客は店舗検索・席予約（事前決済/現地払い選択可）が可能、店舗は予約・売上管理が可能、運営は全体売上を一元管理できるシステム。

### 1.2 成功指標

#### 定量的指標
- 予約完了率 80%以上（予約開始から完了までの離脱を抑制）
- 店舗登録から初回予約受付開始まで30分以内
- 予約処理のレスポンス時間 3秒以内
- システム稼働率 99%以上
- 決済成功率 99%以上（事前決済選択時）

#### 定性的指標
- 顧客が直感的に店舗を見つけ、迷わず予約できる
- 店舗スタッフがITに詳しくなくても簡単に操作できる
- 運営が売上状況をリアルタイムで把握できる
- 予約のダブルブッキングが発生しない
- 事前決済・現地払いの切り替えがスムーズにできる

---

## 2. システム全体像

### 2.1 主要機能一覧
- **顧客機能**: 店舗検索、店舗詳細閲覧、席予約（事前決済/現地払い）、予約履歴管理
- **店舗機能**: 店舗情報管理、席設定、予約管理、売上確認
- **運営機能**: 店舗承認・管理、全体売上管理

### 2.2 ユーザーロールと権限
- **ゲスト**: 店舗一覧・詳細閲覧のみ
- **顧客**: 店舗検索、予約作成・確認・キャンセル
- **店舗**: 自店舗の情報編集、予約管理、売上確認
- **運営**: 全店舗の管理、全体売上確認

### 2.3 認証・認可要件
- **認証方式**: メール + パスワード
- **セキュリティレベル**: 個人情報・決済情報を扱うため中〜高
- **管理機能**: 店舗承認、ユーザー管理

---

## 3. ページ詳細仕様

### 3.1 C-001: ログイン/会員登録

#### 目的
ユーザー認証を行い、各ロールに応じた機能へのアクセスを提供する

#### 主要機能
- メールアドレス + パスワードでのログイン
- 新規会員登録（顧客/店舗）
- パスワードリセット

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 会員登録 | メール、パスワード、ロール | ユーザー作成完了 |
| 取得 | ログイン | メール、パスワード | 認証トークン |
| 更新 | パスワードリセット | メール | リセットメール送信 |

#### データ構造（概念）
```yaml
User:
  識別子: user_id (UUID)
  基本情報:
    - email（必須、一意）
    - password_hash（必須）
    - role（必須: customer/store/admin）
    - name（必須）
  メタ情報:
    - created_at
    - updated_at
```

---

### 3.2 P-001: 店舗一覧・検索

#### 目的
顧客が希望の飲食店を見つけられるようにする

#### 主要機能
- 店舗一覧表示
- キーワード検索
- エリア・ジャンルでの絞り込み

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 店舗一覧取得 | ページ番号、件数 | 店舗リスト |
| 取得 | 店舗検索 | キーワード、エリア、ジャンル | 検索結果 |

#### データ構造（概念）
```yaml
Restaurant:
  識別子: restaurant_id (UUID)
  基本情報:
    - name（必須）
    - description（任意）
    - address（必須）
    - phone（必須）
    - email（必須）
    - genre（必須）
    - area（必須）
    - image_url（任意）
  営業情報:
    - opening_hours（必須）
    - closing_days（任意）
  メタ情報:
    - status（active/pending/inactive）
    - created_at
    - updated_at
  関連:
    - User（1対1: オーナー）
    - Seat（1対多）
```

---

### 3.3 P-002: 店舗詳細・予約

#### 目的
店舗情報を確認し、席予約を完了する

#### 主要機能
- 店舗詳細情報表示
- 空席確認（日時・人数指定）
- 予約作成（事前決済/現地払い選択）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 店舗詳細取得 | restaurant_id | 店舗詳細情報 |
| 取得 | 空席確認 | restaurant_id, date, time, party_size | 空席状況 |
| 作成 | 予約作成 | restaurant_id, date, time, party_size, payment_method | 予約情報 |

#### 処理フロー
1. 顧客が日時・人数を選択
2. システムが空席を確認
3. 顧客が決済方法を選択（事前決済/現地払い）
4. 事前決済の場合、Stripe決済画面へ
5. 予約確定、確認メール送信

#### データ構造（概念）
```yaml
Reservation:
  識別子: reservation_id (UUID)
  基本情報:
    - restaurant_id（必須）
    - user_id（必須）
    - date（必須）
    - time（必須）
    - party_size（必須）
    - payment_method（必須: online/onsite）
    - payment_status（必須: pending/paid/refunded）
    - status（必須: confirmed/cancelled/completed）
  金額情報:
    - amount（必須）
    - stripe_payment_id（任意）
  メタ情報:
    - created_at
    - updated_at
  関連:
    - User（多対1）
    - Restaurant（多対1）

Seat:
  識別子: seat_id (UUID)
  基本情報:
    - restaurant_id（必須）
    - name（必須: テーブル1など）
    - capacity（必須）
  メタ情報:
    - created_at
    - updated_at
```

---

### 3.4 P-003: マイページ（予約履歴）

#### 目的
顧客が自分の予約を確認・管理する

#### 主要機能
- 予約一覧表示（今後の予約/過去の予約）
- 予約詳細確認
- 予約キャンセル

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 予約一覧取得 | user_id | 予約リスト |
| 取得 | 予約詳細取得 | reservation_id | 予約詳細 |
| 更新 | 予約キャンセル | reservation_id | キャンセル結果 |

---

### 3.5 S-001: 店舗情報管理

#### 目的
店舗が自店の情報と席を管理する

#### 主要機能
- 店舗基本情報の編集
- 営業時間・定休日の設定
- 席（テーブル）の登録・編集・削除

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 店舗情報取得 | restaurant_id | 店舗情報 |
| 更新 | 店舗情報更新 | restaurant_id, 更新データ | 更新結果 |
| 作成 | 席登録 | restaurant_id, name, capacity | 席情報 |
| 更新 | 席編集 | seat_id, 更新データ | 更新結果 |
| 削除 | 席削除 | seat_id | 削除結果 |

---

### 3.6 S-002: 予約管理

#### 目的
店舗が予約状況を把握し管理する

#### 主要機能
- 予約一覧表示（日付でフィルタ）
- 予約詳細確認
- 予約ステータス更新（来店確認、キャンセル）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 予約一覧取得 | restaurant_id, date | 予約リスト |
| 更新 | ステータス更新 | reservation_id, status | 更新結果 |

---

### 3.7 S-003: 売上管理

#### 目的
店舗が売上状況を確認する

#### 主要機能
- 日別/月別売上表示
- 事前決済/現地払い別の集計
- 予約件数の推移

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 売上集計取得 | restaurant_id, period | 売上データ |

---

### 3.8 A-001: 店舗管理（運営）

#### 目的
運営が全店舗を管理・承認する

#### 主要機能
- 店舗一覧表示
- 店舗承認/却下
- 店舗ステータス変更

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 全店舗一覧取得 | ページ番号、ステータス | 店舗リスト |
| 更新 | 店舗承認 | restaurant_id | 承認結果 |
| 更新 | ステータス変更 | restaurant_id, status | 更新結果 |

---

### 3.9 A-002: 全体売上管理（運営）

#### 目的
運営が全体の売上状況を把握する

#### 主要機能
- 全店舗の総売上表示
- 店舗別売上ランキング
- 期間別売上推移

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 全体売上集計 | period | 総売上データ |
| 取得 | 店舗別売上 | period | 店舗別売上リスト |

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
User:
  概要: システム利用者（顧客/店舗/運営）
  主要属性:
    - 認証情報（email, password_hash）
    - プロフィール（name, role）
  関連:
    - Restaurant（1対1: 店舗ロールの場合）
    - Reservation（1対多: 顧客ロールの場合）

Restaurant:
  概要: 飲食店情報
  主要属性:
    - 基本情報（name, description, address, phone）
    - 営業情報（opening_hours, closing_days）
    - 分類（genre, area）
  関連:
    - User（1対1: オーナー）
    - Seat（1対多）
    - Reservation（1対多）

Seat:
  概要: 店舗の席（テーブル）
  主要属性:
    - 識別情報（name）
    - 収容人数（capacity）
  関連:
    - Restaurant（多対1）

Reservation:
  概要: 予約情報
  主要属性:
    - 予約内容（date, time, party_size）
    - 決済情報（payment_method, payment_status, amount）
    - ステータス（status）
  関連:
    - User（多対1）
    - Restaurant（多対1）
```

### 4.2 エンティティ関係図
```
User ─┬─ Restaurant（1対1: 店舗オーナー）
      └─ Reservation（1対多: 顧客の予約）

Restaurant ─┬─ Seat（1対多）
            └─ Reservation（1対多）
```

### 4.3 バリデーションルール
```yaml
email:
  - ルール: 有効なメール形式、一意
  - 理由: 認証とメール通知のため

password:
  - ルール: 8文字以上
  - 理由: セキュリティ確保のため

party_size:
  - ルール: 1以上、席のcapacity以下
  - 理由: 適切な席割り当てのため

date:
  - ルール: 現在日以降
  - 理由: 過去の日付での予約防止
```

---

## 5. 制約事項

### 外部API制限
- **Stripe**: 決済手数料 3.6% + 消費税

### 技術的制約
- **予約の同時実行制御**: PostgreSQLトランザクションで排他制御
- **リアルタイム更新**: SSE（Server-Sent Events）を使用

---

## 5.1 セキュリティ要件

### 基本方針
本プロジェクトは **CVSS 3.1（Common Vulnerability Scoring System）** に準拠したセキュリティ要件を満たすこと。

### プロジェクト固有の必須要件

**認証機能（必須）**:
- ブルートフォース攻撃対策（アカウントロックアウト）
- パスワードポリシー（8文字以上）
- セッション管理（タイムアウト、CSRF対策）

**決済機能（必須）**:
- PCI DSS準拠（Stripe利用で対応）
- トランザクションログ記録

**その他の一般要件**:
- HTTPSの強制（本番環境）
- セキュリティヘッダー設定（本番環境）
- 入力値のサニタイゼーション
- エラーメッセージでの情報漏洩防止

---

### 運用要件：可用性とヘルスチェック

**ヘルスチェックエンドポイント（必須）**:
- エンドポイント: `/api/health`
- 目的: Cloud Runでのliveness/readinessプローブ
- 要件: データベース接続確認、5秒以内の応答

**グレースフルシャットダウン（必須）**:
- SIGTERMシグナルハンドラーの実装
- 進行中のリクエスト完了まで待機
- タイムアウト: 8秒

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 予約作成（事前決済）
**トリガー**: 「予約を確定する」ボタンクリック（事前決済選択時）
**フロントエンドAPI**: POST /api/reservations
**バックエンド内部処理**:
1. 空席確認（トランザクション開始）
2. 仮予約レコード作成
3. Stripe Payment Intent作成
4. 決済完了後、予約確定
5. 確認メール送信
**結果**: 予約完了通知
**外部サービス依存**: Stripe API

### 複合処理-002: 予約キャンセル（返金）
**トリガー**: 「予約をキャンセル」ボタンクリック（事前決済済み）
**フロントエンドAPI**: POST /api/reservations/{id}/cancel
**バックエンド内部処理**:
1. 予約ステータス確認
2. Stripe返金処理
3. 予約ステータス更新
4. キャンセルメール送信
**結果**: キャンセル完了通知
**外部サービス依存**: Stripe API

---

## 7. 技術スタック

```yaml
フロントエンド:
  - React 18
  - TypeScript 5
  - MUI v6
  - React Router v6
  - Zustand
  - React Query
  - Vite 5

バックエンド:
  - Python 3.12
  - FastAPI
  - SQLAlchemy
  - Pydantic

データベース:
  - PostgreSQL（Neon）

インフラ:
  - フロントエンド: Vercel
  - バックエンド: Google Cloud Run
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Stripe | 決済処理 | https://stripe.com | 3.6%/決済 |
| Neon | PostgreSQL | https://neon.tech | 無料枠あり |
| Vercel | フロントエンド | https://vercel.com | 無料枠あり |
| Google Cloud | バックエンド | https://cloud.google.com | 従量課金 |

---

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

（拡張候補 - 実装はしない）
- クーポン/ポイント機能
- レビュー・評価機能
- プッシュ通知
- 多言語対応
